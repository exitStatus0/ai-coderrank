# =============================================================================
# CronJob
# =============================================================================
# Daily data refresh job
# Fetches latest leaderboard data and updates the shared storage
#
# Schedule: Every day at 3:00 AM UTC (off-peak hours)
# =============================================================================

apiVersion: batch/v1
kind: CronJob
metadata:
  name: ai-coderrank-update
  namespace: ai-coderrank
  labels:
    app.kubernetes.io/name: ai-coderrank
    app.kubernetes.io/component: cronjob
spec:
  # Run daily at 3:00 AM UTC
  schedule: "0 3 * * *"
  
  # Timezone (requires Kubernetes 1.27+)
  # timeZone: "UTC"
  
  # Job settings
  concurrencyPolicy: Forbid  # Don't run if previous job is still running
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 300  # 5 minute window to start
  
  jobTemplate:
    spec:
      # Job timeout
      activeDeadlineSeconds: 600  # 10 minutes max
      backoffLimit: 3
      
      template:
        metadata:
          labels:
            app.kubernetes.io/name: ai-coderrank
            app.kubernetes.io/component: cronjob
        spec:
          restartPolicy: OnFailure
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
            fsGroup: 1001
          
          containers:
            - name: updater
              image: ai-coderrank-cronjob:latest  # Replace with your registry
              imagePullPolicy: IfNotPresent
              
              # Command to run the update script
              command:
                - npx
                - tsx
                - src/scripts/update-data.ts
              
              # Environment from ConfigMap
              envFrom:
                - configMapRef:
                    name: ai-coderrank-config
              
              # Resource limits (lighter than web app)
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 200m
                  memory: 256Mi
              
              # Mount shared data volume
              volumeMounts:
                - name: data
                  mountPath: /app/data
              
              # Security context
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL
          
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: ai-coderrank-data

---
# =============================================================================
# Manual Job (for testing)
# =============================================================================
# Run manually: kubectl create job --from=cronjob/ai-coderrank-update manual-update -n ai-coderrank
# Or apply this manifest directly for one-time testing
# =============================================================================

# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: ai-coderrank-manual-update
#   namespace: ai-coderrank
# spec:
#   template:
#     spec:
#       restartPolicy: Never
#       containers:
#         - name: updater
#           image: ai-coderrank-cronjob:latest
#           command: ["npx", "tsx", "src/scripts/update-data.ts"]
#           envFrom:
#             - configMapRef:
#                 name: ai-coderrank-config
#           volumeMounts:
#             - name: data
#               mountPath: /app/data
#       volumes:
#         - name: data
#           persistentVolumeClaim:
#             claimName: ai-coderrank-data
